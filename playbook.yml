---
# Configure VM, Install Docker, Instana Agent and Deploy Robot Shop
# It's a one-click automation that installs everything needed (Docker, monitoring agent, application) on your VM and 
#gets Robot Shop running with Instana monitoring enabled.
# creates the Robot Shop application configuration files (docker-compose.yml and instana-config.yaml), and deploys all 12 microservices (web, cart, payment, shipping, etc.) 

- name: Configure VM, Install Docker, Instana Agent and Deploy Robot Shop
  hosts: vm
  become: yes
  gather_facts: yes
  vars:
    ansible_python_interpreter: /usr/bin/python3
    robot_shop_dir: /opt/robot-shop
    instana_agent_key: "{{ lookup('env', 'INSTANA_AGENT_KEY') }}"
    instana_endpoint_host: "{{ lookup('env', 'INSTANA_ENDPOINT_HOST') }}"
    instana_endpoint_port: "{{ lookup('env', 'INSTANA_ENDPOINT_PORT') | default('443', true) }}"
    instana_zone: "{{ lookup('env', 'INSTANA_ZONE') | default('robot-shop-zone', true) }}"
    
  tasks:

    - name: Update apt cache
      apt:
        update_cache: yes
        cache_valid_time: 3600

    - name: Install prerequisites for Docker
      apt:
        name:
          - ca-certificates
          - curl
          - gnupg
          - lsb-release
          - git
          - wget
        state: present

    - name: Download get-pip.py
      get_url:
        url: https://bootstrap.pypa.io/get-pip.py
        dest: /tmp/get-pip.py
        mode: '0755'

    - name: Install pip3
      command: python3 /tmp/get-pip.py
      args:
        creates: /usr/local/bin/pip3

    - name: Create directory for Docker GPG key
      file:
        path: /etc/apt/keyrings
        state: directory
        mode: '0755'

    - name: Add Docker GPG key
      shell: |
        curl -fsSL https://download.docker.com/linux/ubuntu/gpg | gpg --dearmor -o /etc/apt/keyrings/docker.gpg
        chmod a+r /etc/apt/keyrings/docker.gpg
      args:
        creates: /etc/apt/keyrings/docker.gpg

    - name: Add Docker repository
      shell: |
        echo "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.gpg] https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable" | tee /etc/apt/sources.list.d/docker.list > /dev/null
      args:
        creates: /etc/apt/sources.list.d/docker.list

    - name: Update apt cache after adding Docker repo
      apt:
        update_cache: yes

    - name: Install Docker
      apt:
        name:
          - docker-ce
          - docker-ce-cli
          - containerd.io
          - docker-buildx-plugin
          - docker-compose-plugin
        state: present

    - name: Start and enable Docker service
      systemd:
        name: docker
        state: started
        enabled: yes

    - name: Add root user to docker group
      user:
        name: root
        groups: docker
        append: yes

    - name: Remove all old docker-compose installations
      shell: |
        pip3 uninstall -y docker-compose || true
        rm -f /usr/local/bin/docker-compose
        rm -f /usr/bin/docker-compose
      ignore_errors: yes

    - name: Install Docker Compose v2 standalone binary
      get_url:
        url: https://github.com/docker/compose/releases/download/v2.24.0/docker-compose-linux-x86_64
        dest: /usr/local/bin/docker-compose
        mode: '0755'
      
    - name: Verify docker-compose is the standalone binary (not Python-based)
      shell: |
        file /usr/local/bin/docker-compose | grep -q "ELF.*executable"
      register: compose_binary_check
      failed_when: false
      changed_when: false

    - name: Install Docker Python library (for Ansible docker modules only)
      pip:
        name:
          - docker==6.1.3
          - 'urllib3<2'
        executable: pip3

    - name: Verify Docker installation
      command: docker --version
      register: docker_version
      changed_when: false

    - name: Display Docker version
      debug:
        msg: "Docker installed: {{ docker_version.stdout }}"

    - name: Verify Docker Compose installation
      command: /usr/local/bin/docker-compose --version
      register: compose_version
      changed_when: false
      failed_when: false

    - name: Display Docker Compose version
      debug:
        msg: "Docker Compose installed: {{ compose_version.stdout }}"
      when: compose_version.rc == 0

    # Install and Configure Instana Agent
    - name: Check if Instana agent is already installed
      stat:
        path: /opt/instana/agent
      register: instana_installed

    - name: Download Instana agent setup script
      get_url:
        url: https://setup.instana.io/agent
        dest: /tmp/setup_agent.sh
        mode: '0755'
      when: not instana_installed.stat.exists and instana_agent_key != ""

    - name: Install Instana agent
      shell: |
        /tmp/setup_agent.sh -a {{ instana_agent_key }} \
          -t dynamic \
          -e {{ instana_endpoint_host }}:{{ instana_endpoint_port }} \
          -s \
          -y
      when: not instana_installed.stat.exists and instana_agent_key != ""
      register: instana_install_result

    - name: Create Instana agent configuration directory
      file:
        path: /opt/instana/agent/etc/instana
        state: directory
        mode: '0755'
      when: instana_agent_key != ""

    - name: Configure Instana agent with custom zone and tags
      copy:
        dest: /opt/instana/agent/etc/instana/configuration.yaml
        content: |
          # Instana Agent Configuration
          com.instana.plugin.generic.hardware:
            enabled: true
            availability-zone: '{{ instana_zone }}'

          # Host configuration
          com.instana.plugin.host:
            tags:
              - 'robot-shop'
              - 'terraform-managed'
              - 'aws-ec2'
              - 'docker-host'

          # Docker monitoring
          com.instana.plugin.docker:
            enabled: true
        mode: '0644'
      when: instana_agent_key != ""

    - name: Wait for Instana agent to start collecting data
      pause:
        seconds: 30
      when: instana_agent_key != ""

    - name: Create Instana Application Perspective via API
      uri:
        url: "{{ instana_endpoint_host }}/api/application-monitoring/settings/application"
        method: POST
        headers:
          Authorization: "apiToken {{ lookup('env', 'INSTANA_API_TOKEN') }}"
          Content-Type: "application/json"
        body_format: json
        body:
          label: "Robot-Shop-Microservices-Daneshwari-2026"
          scope: "INCLUDE_ALL_DOWNSTREAM"
          boundaryScope: "ALL"
          matchSpecification:
            type: "BINARY_OP"
            left:
              type: "TAG_FILTER"
              name: "service.name"
              operator: "CONTAINS"
              value: "robot-shop"
            conjunction: "AND"
            right:
              type: "TAG_FILTER"
              name: "service.name"
              operator: "NOT_EMPTY"
        status_code: [200, 201, 409]
        validate_certs: no
      register: app_perspective_result
      when: instana_agent_key != "" and lookup('env', 'INSTANA_API_TOKEN') != ""
      ignore_errors: yes

    - name: Display Application Perspective creation result
      debug:
        msg: "Application Perspective: {{ app_perspective_result.json.label if app_perspective_result.json is defined else 'Already exists or creation failed' }}"
      when: instana_agent_key != "" and lookup('env', 'INSTANA_API_TOKEN') != ""
      notify: Restart Instana agent

    - name: Ensure Instana agent service is started and enabled
      systemd:
        name: instana-agent
        state: started
        enabled: yes
      when: instana_agent_key != ""
      ignore_errors: yes

    - name: Wait for Instana agent to be ready
      wait_for:
        port: 42699
        delay: 5
        timeout: 60
      when: instana_agent_key != ""
      ignore_errors: yes

    - name: Display Instana agent status
      command: systemctl status instana-agent
      register: instana_status
      changed_when: false
      when: instana_agent_key != ""
      ignore_errors: yes

    - name: Show Instana agent status
      debug:
        msg: "{{ instana_status.stdout_lines }}"
      when: instana_agent_key != "" and instana_status is defined

    # Deploy Robot Shop Application
    - name: Create robot-shop directory
      file:
        path: "{{ robot_shop_dir }}"
        state: directory
        mode: '0755'

    - name: Create docker-compose.yml for Robot Shop
      copy:
        dest: "{{ robot_shop_dir }}/docker-compose.yml"
        content: |
          version: '3'
          services:
            mongodb:
              image: robotshop/rs-mongodb:latest
              container_name: mongodb
              networks:
                - robot-shop
              restart: always

            redis:
              image: redis:6.2-alpine
              container_name: redis
              networks:
                - robot-shop
              restart: always

            rabbitmq:
              image: rabbitmq:3.11-management-alpine
              container_name: rabbitmq
              networks:
                - robot-shop
              restart: always

            catalogue:
              image: robotshop/rs-catalogue:latest
              container_name: catalogue
              depends_on:
                - mongodb
              networks:
                - robot-shop
              restart: always
              environment:
                - INSTANA_AGENT_HOST=host.docker.internal

            user:
              image: robotshop/rs-user:latest
              container_name: user
              depends_on:
                - mongodb
                - redis
              networks:
                - robot-shop
              restart: always
              environment:
                - INSTANA_AGENT_HOST=host.docker.internal

            cart:
              image: robotshop/rs-cart:latest
              container_name: cart
              depends_on:
                - redis
              networks:
                - robot-shop
              restart: always
              environment:
                - INSTANA_AGENT_HOST=host.docker.internal

            mysql:
              image: robotshop/rs-mysql-db:latest
              container_name: mysql
              networks:
                - robot-shop
              restart: always

            shipping:
              image: robotshop/rs-shipping:latest
              container_name: shipping
              depends_on:
                - mysql
              networks:
                - robot-shop
              restart: always
              environment:
                - INSTANA_AGENT_HOST=host.docker.internal

            ratings:
              image: robotshop/rs-ratings:latest
              container_name: ratings
              depends_on:
                - mysql
              networks:
                - robot-shop
              restart: always
              environment:
                - INSTANA_AGENT_HOST=host.docker.internal

            payment:
              image: robotshop/rs-payment:latest
              container_name: payment
              depends_on:
                - rabbitmq
              networks:
                - robot-shop
              restart: always
              environment:
                - INSTANA_AGENT_HOST=host.docker.internal

            dispatch:
              image: robotshop/rs-dispatch:latest
              container_name: dispatch
              depends_on:
                - rabbitmq
              networks:
                - robot-shop
              restart: always
              environment:
                - INSTANA_AGENT_HOST=host.docker.internal

            web:
              image: robotshop/rs-web:latest
              container_name: web
              depends_on:
                - catalogue
                - user
                - cart
                - shipping
                - payment
              ports:
                - "8080:8080"
              networks:
                - robot-shop
              restart: always
              environment:
                - INSTANA_AGENT_HOST=host.docker.internal

          networks:
            robot-shop:
              driver: bridge
        mode: '0644'

    - name: Download docker-compose-load.yaml for load testing
      get_url:
        url: https://raw.githubusercontent.com/instana/robot-shop/master/docker-compose-load.yaml
        dest: "{{ robot_shop_dir }}/docker-compose-load.yaml"
        mode: '0644'
      ignore_errors: yes

    - name: Pull Robot Shop Docker images (with retry for rate limits)
      command: /usr/local/bin/docker-compose pull
      args:
        chdir: "{{ robot_shop_dir }}"
      register: pull_result
      changed_when: "'Pulling' in pull_result.stdout"
      retries: 3
      delay: 60
      until: pull_result.rc == 0
      ignore_errors: yes

    - name: Start Robot Shop application (will pull missing images)
      command: /usr/local/bin/docker-compose up -d
      args:
        chdir: "{{ robot_shop_dir }}"
      register: compose_result
      retries: 3
      delay: 30
      until: compose_result.rc == 0

    - name: Wait for Robot Shop to be ready
      uri:
        url: "http://localhost:8080"
        status_code: 200
      register: result
      until: result.status == 200
      retries: 30
      delay: 10
      ignore_errors: yes

    - name: Get running containers
      shell: docker ps --format "table {{'{{'}}.Names{{'}}'}}\t{{'{{'}}.Status{{'}}'}}\t{{'{{'}}.Ports{{'}}'}}"
      register: containers
      changed_when: false

    - name: Display running containers
      debug:
        msg: "{{ containers.stdout_lines }}"

    - name: Display Robot Shop access information
      debug:
        msg:
          - "=========================================="
          - "Robot Shop Application Deployed!"
          - "=========================================="
          - "Access URL: http://{{ ansible_host }}:8080"
          - "All services are running in Docker containers"
          - "=========================================="
          - ""
          - "Instana Monitoring:"
          - "  Agent Status: {{ 'Installed and Running' if instana_agent_key != '' else 'Not Configured' }}"
          - "  Zone: {{ instana_zone if instana_agent_key != '' else 'N/A' }}"
          - "  Endpoint: {{ instana_endpoint_host if instana_agent_key != '' else 'N/A' }}"
          - "=========================================="

  handlers:
    - name: Restart Instana agent
      systemd:
        name: instana-agent
        state: restarted
      ignore_errors: yes

# Made with Bob
